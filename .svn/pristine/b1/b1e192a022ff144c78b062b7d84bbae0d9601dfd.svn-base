<?php namespace JerryLib\User;

use JerryLib\Config\Config;
use JerryLib\System\Common;
use JerryLib\System\Init;
use JerryLib\DB\tabHad;

class userLog {

    protected $tabHad;
    protected $config;
    protected $allowSetting;

    //继承Init单例模式
    use Init;

    /**
     * 构造函数
     */
    public function __construct($table = '') {
        $this->tabHad = tabHad::Init($table);
//        $this->config = config::getInstance();
//        $this->allowSetting = $this->config->section('security');
        return $this;
    }

    /**
     * 克隆函数，防止克隆
     */
    private function __clone() {
        throw new \Exception('对不起,不能克隆!');
    }

    /**
     * 写日志
     * @param $userid
     * @param $eventType
     * @param $eventFlag
     * @param $eventContent
     */
    protected function writeLog($userid, $eventContent, $eventFlag, $eventType) {
        $this->tabHad->insert([
            'sessionID' => session()->getId(),
            'uid' => $userid,
            'ip' => Common::get_real_ip(),
            'date' => date('Y-m-d H:i:s'),
            'type' => $eventType,
            'flag' => $eventFlag,
            'content' => $eventContent
        ]);
    }

    /**
     * 写用户日志
     * @param string $userid
     * @param int $eventType
     * @param $eventContent
     */
    public function writeUserLog($userid = '', $eventContent, $eventFlag, $eventType = 1) {
        $userid or $userid = session('_AUTH_USER_UID');
        $this->writeLog($userid, $eventContent, $eventFlag, $eventType);
    }

    /**
     * 写系统日志
     * @param int $eventType
     * @param $eventContent
     */
    public function writeSystemLog($eventContent, $eventFlag = 1, $eventType = 2) {
        $this->writeLog(999999, $eventContent, $eventFlag, $eventType);
    }

    /**
     * 获取30分钟之内登录出错的次数
     * @param $uid
     */
    public function getErrorTime($uid = '') {
        $data = $this->tabHad->select('id', 'type=1 and flag=0 and UNIX_TIMESTAMP(date)>(UNIX_TIMESTAMP()-1800) and uid=' . $uid);
        return count($data);
    }

}